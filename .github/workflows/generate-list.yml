name: Compile Component & Logix Lists

on:
  push:
  workflow_dispatch:

jobs:
  generate-component-list:
    name: "Generate Lists"
    # The type of runner that the job will run on.
    runs-on: ubuntu-latest

    steps:
      # Lets get SteamCMD downloaded.
    - name: Install SteamCMD
      # Check for a Resonite cache
      uses: CyberAndrii/setup-steamcmd@v1

      # And now to download Resonite.
    - name: Install Resonite
      # Check for a Resonite cache
      run: steamcmd +force_install_dir $HOME/Steam/steamapps/common/Resonite +login ${{ secrets.PASSCODE }} +app_update 2519830 validate +quit

    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it.
    - name: Checkout
      uses: actions/checkout@v3

    # Moves our custom cs file into the correct location.
    - name: Move Scripts
      run: |
        mv $GITHUB_WORKSPACE/script/FrooxEngineTypeParser.cs $HOME/Steam/steamapps/common/Resonite/Resonite_Data/Managed/
        mv $GITHUB_WORKSPACE/script/FrooxEngineTypeParser.csproj $HOME/Steam/steamapps/common/Resonite/Resonite_Data/Managed/

    # Runs our custom cs file to generate the list.
    - name: Build Script
      id: generate-list
      run: |
        cd $HOME/Steam/steamapps/common/Resonite/Resonite_Data/Managed/
        dotnet build
        dotnet run

    # Moves our generated list into root of our repo.
    - name: Move Output File
      run: |
        mv $HOME/Steam/steamapps/common/Resonite/Resonite_Data/Managed/ComponentList.txt $GITHUB_WORKSPACE
        mv $HOME/Steam/steamapps/common/Resonite/Resonite_Data/Managed/ProtoFluxList.txt $GITHUB_WORKSPACE
        cd $GITHUB_WORKSPACE

    # Commits the changes to the repo.
    - name: Commit
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Component List"
        git pull origin main
        git add ComponentList.txt
        git add ProtofluxList.txt
        git commit -m "Automatic component list compile" || true

    # Pushes the changes to the repo.
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
